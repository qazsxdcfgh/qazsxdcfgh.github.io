<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNIST ONNX Model Deployment</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxjs/dist/onnx.min.js"></script>
</head>
<body>
    <input type="file" id="imageUpload" accept="image/*" />
    <script>
        async function runModel(imageData) {
            // Load the ONNX model
            const session = new onnx.InferenceSession();
            await session.loadModel('onnx_model_1.onnx');

            // Prepare input tensor from the image data
            const inputTensor = preprocessImage(imageData);

            // Run inference
            const outputMap = await session.run([inputTensor]);
            const outputTensor = outputMap.values().next().value;

            // Do something with the output
            console.log(outputTensor.data);
            alert("Prediction: " + argMax(outputTensor.data));
        }

        function preprocessImage(imageData) {
            // Convert image data to grayscale and normalize it
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 28;
            canvas.height = 28;
            ctx.drawImage(imageData, 0, 0, 28, 28);
            const imageDataArray = ctx.getImageData(0, 0, 28, 28).data;
            const grayscaleArray = new Float32Array(28 * 28);

            for (let i = 0; i < 28 * 28; i++) {
                const r = imageDataArray[i * 4];
                const g = imageDataArray[i * 4 + 1];
                const b = imageDataArray[i * 4 + 2];
                grayscaleArray[i] = (r + g + b) / 3 / 255.0; // Normalize to [0, 1]
            }

            return new onnx.Tensor(grayscaleArray, 'float32', [1, 1, 28, 28]);
        }

        function argMax(array) {
            return array.indexOf(Math.max.apply(null, array));
        }

        document.getElementById('imageUpload').addEventListener('change', (event) => {
            const reader = new FileReader();
            reader.onload = function () {
                const image = new Image();
                image.onload = function () {
                    runModel(image);
                };
                image.src = reader.result;
            };
            reader.readAsDataURL(event.target.files[0]);
        });
    </script>
</body>
</html>
